name: CI/CD Pipeline with Stress Testing

on:
  push:
    branches: [ main ]

env:
  PROJECT_ID: YOUR_PROJECT_ID
  GKE_CLUSTER: iris-cluster
  GKE_ZONE: us-central1-a
  IMAGE: iris-classifier

jobs:
  setup-build-deploy:
    name: Setup, Build, and Deploy
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Train model
      run: |
        python train.py

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1

    - name: Configure Docker for GCR
      run: |
        gcloud auth configure-docker

    - name: Build Docker image
      run: |
        docker build -t gcr.io/$PROJECT_ID/$IMAGE:$GITHUB_SHA .

    - name: Push Docker image
      run: |
        docker push gcr.io/$PROJECT_ID/$IMAGE:$GITHUB_SHA

    - name: Get GKE credentials
      run: |
        gcloud container clusters get-credentials $GKE_CLUSTER --zone $GKE_ZONE

    - name: Deploy to Kubernetes
      run: |
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml
        kubectl set image deployment/iris-classifier iris-api=gcr.io/$PROJECT_ID/$IMAGE:$GITHUB_SHA
        kubectl rollout status deployment/iris-classifier

    - name: Apply HPA
      run: |
        kubectl apply -f k8s/hpa.yaml

  stress-test:
    name: Stress Test
    runs-on: ubuntu-latest
    needs: setup-build-deploy

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Install wrk
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libssl-dev git
        git clone https://github.com/wg/wrk.git
        cd wrk
        make
        sudo cp wrk /usr/local/bin

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1

    - name: Get GKE credentials
      run: |
        gcloud container clusters get-credentials $GKE_CLUSTER --zone $GKE_ZONE

    - name: Get Service IP
      id: get-ip
      run: |
        EXTERNAL_IP=""
        while [ -z $EXTERNAL_IP ]; do
          echo "Waiting for external IP..."
          EXTERNAL_IP=$(kubectl get svc iris-classifier-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          [ -z "$EXTERNAL_IP" ] && sleep 10
        done
        echo "EXTERNAL_IP=$EXTERNAL_IP" >> $GITHUB_OUTPUT

    - name: Create test script
      run: |
        cat > test.lua << 'EOF'
        wrk.method = "POST"
        wrk.body   = '{"sepal_length": 5.1, "sepal_width": 3.5, "petal_length": 1.4, "petal_width": 0.2}'
        wrk.headers["Content-Type"] = "application/json"
        EOF

    - name: Test 1 - 1000 req with 1 pod
      run: |
        echo "=== Test 1: 1000 requests, 1 pod max ==="
        kubectl patch hpa iris-classifier-hpa -p '{"spec":{"maxReplicas":1}}'
        sleep 30
        wrk -t4 -c100 -d30s -s test.lua --latency http://${{ steps.get-ip.outputs.EXTERNAL_IP }}/predict
        kubectl get hpa
        kubectl top pods

    - name: Test 2 - 1000 req with autoscaling
      run: |
        echo "=== Test 2: 1000 requests, autoscaling ==="
        kubectl patch hpa iris-classifier-hpa -p '{"spec":{"maxReplicas":3}}'
        sleep 60
        wrk -t4 -c100 -d30s -s test.lua --latency http://${{ steps.get-ip.outputs.EXTERNAL_IP }}/predict
        kubectl get hpa
        kubectl top pods

    - name: Test 3 - 2000 req with 1 pod (bottleneck)
      run: |
        echo "=== Test 3: 2000 requests, 1 pod (bottleneck) ==="
        kubectl patch hpa iris-classifier-hpa -p '{"spec":{"maxReplicas":1}}'
        kubectl scale deployment iris-classifier --replicas=1
        sleep 30
        wrk -t8 -c200 -d30s -s test.lua --latency http://${{ steps.get-ip.outputs.EXTERNAL_IP }}/predict
        kubectl get hpa
        kubectl top pods

    - name: Test 4 - 2000 req with autoscaling
      run: |
        echo "=== Test 4: 2000 requests, autoscaling ==="
        kubectl patch hpa iris-classifier-hpa -p '{"spec":{"maxReplicas":3}}'
        sleep 60
        wrk -t8 -c200 -d30s -s test.lua --latency http://${{ steps.get-ip.outputs.EXTERNAL_IP }}/predict
        kubectl get hpa
        kubectl top pods
